<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Map & Archive — Cinematic Counter-Cartographies</title>
  <link rel="stylesheet" href="css/style.css">
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.18.0/mapbox-gl.css" rel="stylesheet">
  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 56px; bottom: 0; width: 100%; }
    .search-bar-container {
      position: absolute;
      top: 72px; /* Lowered below the navbar */
      left: 32px; /* Move to left side */
      transform: none;
      z-index: 1001;
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(40,131,102,0.13);
      padding: 0.5em 1em;
      display: flex;
      align-items: center;
      gap: 0.5em;
      width: 320px;
      max-width: 90vw;
    }
    .search-bar-container input[type="text"] {
      flex: 1;
      border: none;
      border-radius: 8px;
      padding: 0.5em;
      font-size: 1rem;
      outline: none;
      background: #f7f6f2;
      color: #222;
    }
    .search-bar-container button {
      background: #288366;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.5em 1em;
      font-size: 1rem;
      cursor: pointer;
      font-weight: bold;
    }
    .search-bar-container button:hover {
      background: #e6a93a;
      color: #222;
    }
    #map-legend {
      position: absolute;
      bottom: 32px;
      left: 32px;
      background: rgba(255,255,255,0.65); /* More transparent */
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(40,131,102,0.13);
      padding: 1.1em 1.4em 1.1em 1.2em;
      font-size: 1.05rem;
      color: #222;
      z-index: 1002;
      min-width: 180px;
    }
    #map-legend div {
      display: flex;
      align-items: center;
      margin-bottom: 0.4em;
    }
    #map-legend span {
      display: inline-block;
      margin-right: 0.7em;
    }
    #map-legend .legend-color {
      width: 18px;
      height: 18px;
      border-radius: 50%;
    }
    #map-legend .checkpoint {
      background: #e6a93a;
      border: 2px solid #b94e3a;
    }
    #map-legend .search-result {
      background: #288366;
      border: 2px solid #fff;
    }
    #map-legend .buildings {
      width: 18px;
      height: 18px;
      background: linear-gradient(120deg,#e6a93a22 0%,#6fe7c1 100%);
      border-radius: 4px;
      border: 1.5px solid #288366;
    }
  </style>
</head>
<body>
  <nav class="topnav">
    <div class="brand">Cinematic Counter‑Cartographies</div>
    <div class="menu">
      <a href="index.html">Home</a>
      <a href="map.html" class="active">Map & Archive</a>
      <a href="checkpoints.html">Checkpoints</a>
      <a href="analysis.html">Visual Analysis</a>
      <a href="not-mapped.html">What's Not Mapped</a>
    </div>
  </nav>

  <div class="search-bar-container">
    <input type="text" id="searchInput" placeholder="Search for a place or location..." autocomplete="off" />
    <button id="searchBtn">Search</button>
    <ul id="searchResults" style="position:absolute;top:2.7em;left:0;width:100%;background:#fff;border-radius:0 0 10px 10px;box-shadow:0 2px 8px #0002;list-style:none;margin:0;padding:0;z-index:1002;max-height:220px;overflow-y:auto;display:none;"></ul>
  </div>

  <div id="map" role="region" aria-label="Interactive map of Palestinian checkpoints"></div>

  <div id="map-legend">
    <div style="font-weight: bold; margin-bottom: 0.5em;">Legend</div>
    <div style="display: flex; align-items: center; margin-bottom: 0.4em;">
      <span class="legend-color checkpoint"></span>
      <span>Checkpoint</span>
    </div>
    <div style="display: flex; align-items: center; margin-bottom: 0.4em;">
      <span class="legend-color search-result"></span>
      <span>Search Result</span>
    </div>
    <div style="display: flex; align-items: center;">
      <span class="buildings"></span>
      <span>3D Buildings (zoom in)</span>
    </div>
  </div>

  <script src="https://api.mapbox.com/mapbox-gl-js/v3.18.0/mapbox-gl.js"></script>
  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiYXdpc21hMDEiLCJhIjoiY21sYjZudTJkMGs5ZTNkcTY2ZXRnbmt0NiJ9.3XcsI4p3lFOou3ulXWFXXQ';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/standard-satellite',
      center: [35.2, 31.9],
      zoom: 9,
      pitch: 45,
      bearing: -17.6,
      antialias: true
    });

    map.on('style.load', () => {
      const layers = map.getStyle().layers;
      const labelLayerId = layers.find(
        (layer) => layer.type === 'symbol' && layer.layout['text-field']
      ).id;

      map.addLayer(
        {
          id: 'add-3d-buildings',
          source: 'composite',
          'source-layer': 'building',
          filter: ['==', 'extrude', 'true'],
          type: 'fill-extrusion',
          minzoom: 15,
          paint: {
            'fill-extrusion-color': '#aaa',
            'fill-extrusion-height': [
              'interpolate',
              ['linear'],
              ['zoom'],
              15, 0,
              15.05, ['get', 'height']
            ],
            'fill-extrusion-base': [
              'interpolate',
              ['linear'],
              ['zoom'],
              15, 0,
              15.05, ['get', 'min_height']
            ],
            'fill-extrusion-opacity': 0.6
          }
        },
        labelLayerId
      );
    });

    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const searchResults = document.getElementById('searchResults');

    let lastResults = [];

    // Helper to extract Arabic name from feature or context
    function getArabicName(feature) {
      // Try direct property
      if (feature.text_ar) return feature.text_ar;
      // Try context array
      if (feature.context) {
        for (const c of feature.context) {
          if (c.language === "ar" && c.text_ar) return c.text_ar;
        }
      }
      return "";
    }

    function showResults(features) {
      searchResults.innerHTML = '';
      if (features.length === 0) {
        searchResults.style.display = 'none';
        return;
      }
      features.forEach((f, idx) => {
        const li = document.createElement('li');
        li.textContent = f.place_name;
        li.style.padding = '0.5em 0.7em';
        li.style.cursor = 'pointer';
        li.onmouseenter = () => li.style.background = '#e6a93a22';
        li.onmouseleave = () => li.style.background = '';
        li.onclick = () => {
          searchResults.style.display = 'none';
          searchInput.value = f.place_name;
          map.flyTo({ center: f.center, zoom: 13 });

          // Get English and Arabic names
          const english = f.text || "";
          const arabic = getArabicName(f);
          let popupContent = `<strong>${english}</strong>`;
          if (arabic && arabic !== english) {
            popupContent += `<br><span style="font-size:1.1em;color:#288366;">${arabic}</span>`;
          }
          popupContent += `<br>${f.place_name}`;

          new mapboxgl.Marker({ color: "#e6a93a" })
            .setLngLat(f.center)
            .setPopup(new mapboxgl.Popup().setHTML(popupContent))
            .addTo(map)
            .togglePopup();
        };
        searchResults.appendChild(li);
      });
      searchResults.style.display = 'block';
    }

    searchInput.addEventListener('input', function() {
      const query = searchInput.value.trim();
      if (!query) {
        searchResults.style.display = 'none';
        return;
      }
      fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${mapboxgl.accessToken}`)
        .then(res => res.json())
        .then(data => {
          lastResults = data.features || [];
          showResults(lastResults);
        });
    });

    searchBtn.addEventListener('click', function() {
      if (lastResults.length > 0) {
        // Use the first result
        const f = lastResults[0];
        map.flyTo({ center: f.center, zoom: 13 });
        new mapboxgl.Marker({ color: "#e6a93a" })
          .setLngLat(f.center)
          .setPopup(new mapboxgl.Popup().setHTML(`<strong>${f.text}</strong><br>${f.place_name}`))
          .addTo(map)
          .togglePopup();
        searchResults.style.display = 'none';
      }
    });

    // Allow pressing Enter to select the first result
    searchInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        if (lastResults.length > 0) {
          const f = lastResults[0];
          map.flyTo({ center: f.center, zoom: 13 });
          new mapboxgl.Marker({ color: "#e6a93a" })
            .setLngLat(f.center)
            .setPopup(new mapboxgl.Popup().setHTML(`<strong>${f.text}</strong><br>${f.place_name}`))
            .addTo(map)
            .togglePopup();
          searchResults.style.display = 'none';
        }
      }
    });

    // Hide results when clicking outside
    document.addEventListener('click', function(e) {
      if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.style.display = 'none';
      }
    });

    // Example checkpoint data (replace/add more as needed)
    const checkpoints = [
      {
        name: "Qalandiya Checkpoint",
        arabic: "حاجز قلنديا",
        coords: [35.2192, 31.8638],
        description: "Most documented checkpoint in the archive."
      },
      {
        name: "Bethlehem — Rachel Checkpoint",
        arabic: "حاجز راحيل (بيت لحم)",
        coords: [35.2043, 31.7031],
        description: "Featured in Jacir’s Salt of This Sea and other films."
      },
      {
        name: "Huwwara Checkpoint",
        arabic: "حاجز حوارة",
        coords: [35.2622, 32.1322],
        description: "Seen in contemporary footage and some archive material."
      },
      {
        name: "Container Checkpoint (Jerusalem)",
        arabic: "حاجز الكونتينر (القدس)",
        coords: [35.2976, 31.6927],
        description: "Known locally as the Container; appears in archive footage."
      },
      {
        name: "Al-Jalama Checkpoint",
        arabic: "حاجز الجلمة",
        coords: [35.2871, 32.5074],
        description: "Northern checkpoint near Jenin."
      },
      {
        name: "Erez Crossing",
        arabic: "معبر إيرز",
        coords: [34.5341, 31.5597],
        description: "Main crossing between Gaza and Israel."
      },
      {
        name: "Tarqumiya Checkpoint",
        arabic: "حاجز ترقوميا",
        coords: [35.0231, 31.5536],
        description: "West of Hebron, major commercial checkpoint."
      }
      // Add more, always with both name and arabic fields
    ];

    // Convert to GeoJSON
    const checkpointGeoJSON = {
      type: "FeatureCollection",
      features: checkpoints.map(cp => ({
        type: "Feature",
        geometry: { type: "Point", coordinates: cp.coords },
        properties: {
          title: cp.name,
          arabic: cp.arabic,
          description: cp.description
        }
      }))
    };

    map.on('load', () => {
      // Add checkpoints as a source
      map.addSource('checkpoints', {
        type: 'geojson',
        data: checkpointGeoJSON
      });

      // Add a layer to visualize the checkpoints
      map.addLayer({
        id: 'checkpoints-layer',
        type: 'circle',
        source: 'checkpoints',
        paint: {
          'circle-radius': 6,
          'circle-color': '#e6a93a',
          'circle-opacity': 0.8
        }
      });

      // Add click event to display popup with checkpoint info
      map.on('click', 'checkpoints-layer', (e) => {
        const coordinates = e.features[0].geometry.coordinates.slice();
        const { title, arabic, description } = e.features[0].properties;

        // Zoom into the clicked checkpoint
        map.flyTo({ center: coordinates, zoom: 14, essential: true });

        new mapboxgl.Popup()
          .setLngLat(coordinates)
          .setHTML(
            `<strong>${title}</strong><br><span style="font-size:1.1em;color:#288366;">${arabic}</span><br>${description}`
          )
          .addTo(map);
      });
    });
  </script>
</body>
</html>